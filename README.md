# gb_31_best_py
## Проект "BestJob"
## Командная разработка по методологии Agile:Scrum
GB 3.1 dev BestPy group job search training project
### Базовая документация к проекту

Основные системные требования:

* Ubuntu 22.04 LTS
* Python 3.10.4
* Django 4.0.4
* Зависимости (Python) из requirements.txt

### Установка необходимого ПО
#### обновляем информацию о репозиториях
```
apt update
```
#### Установка nginx, virtualenv
nginx
```
apt install nginx
```
virtualenv
```
apt install python3-venv
```
#### Готовим директории для проекта
Создаем директорию для хранения статики:
```
mkdir /var/www/bestjob
mkdir /var/www/bestjob/static
```
Создаем пользователя для проекта и переходим в дирректорию пользователя:
```
useradd -g www-data -m django
cd /home/django/ 
```
www-data - название группы, а django - имя пользователя. Могут быть произвольными, но в случае использования других вариантов нужно учитывать эти данные в дальнейшем.

Создаем ssh-ключ для репозитория командой:
```
ssh-keygen
```
Извлекаем ключ для добавления его в репозиторий в качестве Deploy key:
```
cat /root/.ssh/id_rsa.pub
```
Данный ключ в настройках проекта на git нужно добавить как Deploy key. Это нужно для того, чтобы не вводить пароль от git каждый раз при обращении к репозиторию.

###Важно!!! 
```
Потребуется минимальная подготовка репозитория. 
В файле settings.py нужно выполнить следующие действия:
1) В переменную DOMAIN_NAME впишите ссылку на будущий сайт
2) Раскомментируйте строку с переменной STATIC_ROOT
3) Если требуется, поменяйте значение переменной DEBUG
В нашем случае мы использовали адрес в виде ip сервера:
http://80.78.247.147
Также потребуется внести правку в файл Nginx в третью строку
server_name 80.78.247.147;
Укажите нужное имя сервера
```
После добавления ключа скопируйте информацию для клонирования вашего репозитория по SSH, после чего запустите клонирование. 

Клонирование проекта :
```
git clone git@github.com:Necris45/gb_31_best_py.git
```
Перейдите в корневой каталог проекта:
```
cd gb_31_best_py/
```
При необходимости поменяйте ветку:
```
git checkout <branch_name>
```
Сделайте подготовленные скрипты исполняемыми:
```
chmod +x ./deploy.sh
chmod +x ./update.sh
chmod +x ./restart.sh
```
Запустите скрипт deploy.sh
```
./deploy.sh
```
Будьте внимательны, будет использовано автозаполнение тестовыми данными, который потом нужно проиндексировать.
Когда система задаст вопрос, согласитесь. В дальнейшем тестовые данные можно будет удалить, но с ними будет удобнее проверить работоспособность сайта.
После выполнения скрипта сайт будет работать, но для работы отправки писем новым пользователям нужно будет произвести некоторые настройки.

Для настройки отправки писем новым пользователям нужен будет почтовый ящик. Для примера мы использовали ящик на mail.ru и для его работы нужно получить ключ приложения, который будет использоваться в качестве пароля.

Для создания файла с настройками почты удостоверьтесь что вы находитесь в следующей дирректории (/home/django/gb_31_best_py/BestJob) используйте команду:
```
nano .env
```
В открывшемся окне редактора Nano скопируйте следующее:
```
EMAIL_HOST = 'smtp.mail.ru'
EMAIL_PORT = 465
EMAIL_HOST_USER = 'your mail'
EMAIL_HOST_PASSWORD = 'your password'
EMAIL_USE_TLS = False
EMAIL_USE_SSL = True
```
В переменные EMAIL_HOST_USER и EMAIL_HOST_PASSWORD укажите данные почтового ящика.
Если используете ящик не от mail.ru, то обратитесь к техподдержке и получите настройки для соответствующего почтового сервера.
После внесения всех изменений сохраняем файл и выполняем скрипт для перезапуска сервера с новыми настройками.
```
./restart.sh
```
Данный скрипт нужно использовать также после обновления сайта из репозитория.

#### Суперпользователь
Создайте администратора используя команду и введите всю требуемую информацию:
```
python3 manage.py createsuperuser
```
Теперь вы можете войти в админку сайта с использованием введенного в процессе создания логина и пароля. Теперь сайт полностью готов к работе.

#### Обновления сайта
В дальнейшем если Вам будет необходимо обновить данные на сайте (раширите функционал или внесете изменения в дизайн) вам потребуется после подключения к серверу выполнить команду `cd /home/django/gb_31_best_py/BestJob/` и далее в зависимости от способа внесении изменений выполнить соответствующий скрипт.
Для обновления через загрузку изменений из репозитория:
`./update.sh`

Если правки были внесены в настройки проекта вручную, то нужно просто перезапустить nginx и gunicorn скриптом `./restart.sh`

### Autotests
Функционал покрыт автотестами и ниже показаны способы их запуска.

Запуск автотестов из директории проекта - `python -m pytest -v -m all tests/`

Прогон по меткам:
`python -m pytest -v -m 'all and urls and not negative' tests/`

### Allure
Документация на allure: 
`https://docs.qameta.io/allure/#_installing_a_commandline`
Для отображения UI отчёта необходимо установить allure:
```
apt-add-repository ppa:qameta/allure
apt-get update 
apt-get install allure
```
Запуск с формированием allure отчета
`python -m pytest --alluredir=allure_reports -v -m all tests/` где allure_reports - имя для временной папки с отчетами

Запуск сервера allure для просмотра результатов тестов 
`allure serve allure_reports/`
